AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  backend
  Sample SAM Template for backend
Globals:
  Function:
    Timeout: 3
    MemorySize: 128
    Environment:
      Variables:
        ORIGINATION_NUMBER: '+18339471759'
Resources:
  WorkspaceApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub
        - ${ResourceName} From Stack ${AWS::StackName}
        - ResourceName: WorkspaceApi
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: '''*'''
              Access-Control-Allow-Headers: '''*'''
              Access-Control-Allow-Methods: '''GET, POST, PATCH, PUT, DELETE, OPTIONS'''
          ResponseTemplates:
            application/json: '''Unauthorized'''
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: '''*'''
              Access-Control-Allow-Headers: '''*'''
              Access-Control-Allow-Methods: '''GET, POST, PATCH, PUT, DELETE, OPTIONS'''
          ResponseTemplates:
            application/json: '''Internal Server Error'''
      StageName: Prod
      DefinitionBody:
        openapi: '3.0'
        info: {}
        paths:
          /workspace:
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${addWorkspace.Arn}/invocations
              responses: {}
          /workspace/{id}:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getWorkspace.Arn}/invocations
              responses: {}
            put:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${updateWorkspace.Arn}/invocations
              responses: {}
            delete:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${deleteWorkspace.Arn}/invocations
              responses: {}
          /workspace/all:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getAllUserWorkspaces.Arn}/invocations
              responses: {}
          /workspace/deploy/{id}:
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${deployWorkspace.Arn}/invocations
              responses: {}
          /workspace/hide_demo:
            put:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${hideDemo.Arn}/invocations
              responses: {}
          /workspace/scheduled_meetings/{id}:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getScheduledMeetings.Arn}/invocations
              responses: {}
            delete:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${cancelScheduledMeetings.Arn}/invocations
              responses: {}
      EndpointConfiguration: REGIONAL
      TracingEnabled: true
      Cors:
        MaxAge: 5
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
        AllowMethods: '''GET, POST, PATCH, PUT, DELETE, OPTIONS'''
      Auth:
        DefaultAuthorizer: JWTAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          JWTAuthorizer:
            FunctionArn: !GetAtt JWTAuthorizerFunction.Arn
  getWorkspace:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getWorkspace
      CodeUri: src/getWorkspace
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
      Events:
        WorkspaceApiGETworkspaceid:
          Type: Api
          Properties:
            Path: /workspace/{id}
            Method: GET
            RestApiId: !Ref WorkspaceApi
  getWorkspaceLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getWorkspace}
  addWorkspace:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: addWorkspace
      CodeUri: src/addWorkspace
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        WorkspaceApiPOSTworkspace:
          Type: Api
          Properties:
            Path: /workspace
            Method: POST
            RestApiId: !Ref WorkspaceApi
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
                - s3:PutObjectVersionTagging
                - s3:PutObjectTagging
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
  addWorkspaceLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${addWorkspace}
  updateWorkspace:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: updateWorkspace
      CodeUri: src/updateWorkspace
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
      Events:
        WorkspaceApiPUTworkspaceid:
          Type: Api
          Properties:
            Path: /workspace/{id}
            Method: PUT
            RestApiId: !Ref WorkspaceApi
  updateWorkspaceLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${updateWorkspace}
  deleteWorkspace:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: deleteWorkspace
      CodeUri: src/deleteWorkspace
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
      Events:
        WorkspaceApiDELETEworkspaceid:
          Type: Api
          Properties:
            Path: /workspace/{id}
            Method: DELETE
            RestApiId: !Ref WorkspaceApi
  deleteWorkspaceLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${deleteWorkspace}
  WorkspacesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-workspace-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: alias/aws/s3
      PublicAccessBlockConfiguration:
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
  WorkspacesBucketBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WorkspacesBucket
      PolicyDocument:
        Id: RequireEncryptionInTransit
        Version: '2012-10-17'
        Statement:
          - Principal: '*'
            Action: '*'
            Effect: Deny
            Resource:
              - !GetAtt WorkspacesBucket.Arn
              - !Sub ${WorkspacesBucket.Arn}/*
            Condition:
              Bool:
                aws:SecureTransport: 'false'
  WelcomeTemplate:
    Type: AWS::Pinpoint::SmsTemplate
    Properties:
      TemplateName: WelcomeTemplate
      Body: Hello, Ethan! - From Ethan
  AutoSmsPinpointApp:
    Type: AWS::Pinpoint::App
    Properties:
      Name: AutoSmsPinpointApp
  AutoSmsChannel:
    Type: AWS::Pinpoint::SMSChannel
    Properties:
      ApplicationId: !Ref AutoSmsPinpointApp
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: true
      Schema:
        - Name: show_demo
          Required: false
          Mutable: true
          AttributeDataType: Boolean
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      UsernameAttributes:
        - email
      UserPoolName: !Sub ${AWS::StackName}-UserPool
      AutoVerifiedAttributes:
        - email
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - USER_PASSWORD_AUTH
  getUser:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getUser
      CodeUri: src/getUser
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        UserApiGETuser:
          Type: Api
          Properties:
            Path: /user
            Method: GET
            RestApiId: !Ref UserApi
  getUserLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getUser}
  addUser:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: addUser
      CodeUri: src/addUser
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
          BOT_ID: !Ref CellyBot
      Events:
        UserApiPOSTuser:
          Type: Api
          Properties:
            Path: /user
            Method: POST
            RestApiId: !Ref UserApi
  addUserLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${addUser}
  deleteUser:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: deleteUser
      CodeUri: src/deleteUser
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        UserApiDELETEuser:
          Type: Api
          Properties:
            Path: /user
            Method: DELETE
            RestApiId: !Ref UserApi
  deleteUserLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${deleteUser}
  UserApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub
        - ${ResourceName} From Stack ${AWS::StackName}
        - ResourceName: UserApi
      StageName: Prod
      DefinitionBody:
        openapi: '3.0'
        info: {}
        paths:
          /user:
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${addUser.Arn}/invocations
              responses: {}
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUser.Arn}/invocations
              responses: {}
            delete:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${deleteUser.Arn}/invocations
              responses: {}
          /user/confirm:
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${confirmUser.Arn}/invocations
              responses: {}
          /user/resend_code:
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${resendCodeUser.Arn}/invocations
              responses: {}
          /user/login:
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loginUser.Arn}/invocations
              responses: {}
      EndpointConfiguration: REGIONAL
      TracingEnabled: true
      Cors:
        MaxAge: 5
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
        AllowMethods: '''POST, PUT, GET, DELETE'''
  confirmUser:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: confirmUser
      CodeUri: src/confirmUser
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        UserApiPOSTuserconfirm:
          Type: Api
          Properties:
            Path: /user/confirm
            Method: POST
            RestApiId: !Ref UserApi
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
  confirmUserLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${confirmUser}
  loginUser:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: loginUser
      CodeUri: src/loginUser
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        UserApiPOSTuserlogin:
          Type: Api
          Properties:
            Path: /user/login
            Method: POST
            RestApiId: !Ref UserApi
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
  loginUserLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${loginUser}
  resendCodeUser:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: resendCodeUser
      CodeUri: src/resendCodeUser
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        UserApiPOSTuserresendcode:
          Type: Api
          Properties:
            Path: /user/resend_code
            Method: POST
            RestApiId: !Ref UserApi
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
  resendCodeUserLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${resendCodeUser}
  JWTAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: JWTAuthorizerFunction
      CodeUri: src/jwtAuthFunction
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          USER_POOL_ID: !Ref UserPool
          USER_POOL_REGION: !Ref AWS::Region
  JWTAuthorizerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${JWTAuthorizerFunction}
  getAllUserWorkspaces:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getAllUserWorkspaces
      CodeUri: src/getAllUserWorkspaces
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        WorkspaceApiGETworkspaceall:
          Type: Api
          Properties:
            Path: /workspace/all
            Method: GET
            RestApiId: !Ref WorkspaceApi
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
  getAllUserWorkspacesLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getAllUserWorkspaces}
  CellyBot:
    Type: AWS::Lex::Bot
    Properties:
      IdleSessionTTLInSeconds: 300
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/aws-service-role/lexv2.amazonaws.com/AWSServiceRoleForLexV2Bots_34K6AS1XY81
      Name: CellyBot
      DataPrivacy:
        ChildDirected: false
  PinpointLexFunctionIamRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: PinpointLexFunctionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: Logs
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
        - PolicyName: Pinpoint
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - sms-voice:SendTextMessage
                Resource: '*'
        - PolicyName: Lex
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - lex:PostContent
                  - lex:PostText
                  - lex:RecognizeText
                Resource: !Sub arn:aws:lex:${AWS::Region}:${AWS::AccountId}:bot-alias/STPJGYCE7A/3VMZOZI7RH
  PinpointLexFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: PinpointLexFunction
      CodeUri: src/PinpointLexFunction
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Role: !GetAtt PinpointLexFunctionIamRole.Arn
      Events:
        SNS1:
          Type: SNS
          Properties:
            Topic: !Ref SNSTopic1
  SNSTopic1:
    Type: AWS::SNS::Topic
  PinpointLexFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${PinpointLexFunction}
  deployWorkspace:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: deployWorkspace
      CodeUri: src/deployWorkspace
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          BOT_ID: !Ref CellyBot
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
      Events:
        WorkspaceApiPOSTworkspacedeployid:
          Type: Api
          Properties:
            Path: /workspace/deploy/{id}
            Method: POST
            RestApiId: !Ref WorkspaceApi
  deployWorkspaceLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${deployWorkspace}
  SchedulingApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub
        - ${ResourceName} From Stack ${AWS::StackName}
        - ResourceName: SchedulingApi
      StageName: Prod
      DefinitionBody:
        openapi: '3.0'
        info: {}
        paths:
          /scheduling/{id}:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getAvailability.Arn}/invocations
              responses: {}
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${addCalendarEvent.Arn}/invocations
              responses: {}
      EndpointConfiguration: REGIONAL
      TracingEnabled: true
      Cors:
        MaxAge: 5
        AllowOrigin: '''*'''
        AllowMethods: '''*'''
        AllowHeaders: '''*'''
  getAvailability:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getAvailability
      CodeUri: src/getAvailability
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        SchedulingApiGETschedulingid:
          Type: Api
          Properties:
            Path: /scheduling/{id}
            Method: GET
            RestApiId: !Ref SchedulingApi
  getAvailabilityLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getAvailability}
  addCalendarEvent:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: addCalendarEvent
      CodeUri: src/addCalendarEvent
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        SchedulingApiPOSTschedulingid:
          Type: Api
          Properties:
            Path: /scheduling/{id}
            Method: POST
            RestApiId: !Ref SchedulingApi
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
          SCHEDULEDMEETINGSTABLE_TABLE_NAME: !Ref ScheduledMeetingsTable
          SCHEDULEDMEETINGSTABLE_TABLE_ARN: !GetAtt ScheduledMeetingsTable.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:CreateSecret
                - secretsmanager:UpdateSecret
                - secretsmanager:DescribeSecret
                - secretsmanager:RotateSecret
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
            - Effect: Allow
              Action:
                - sms-voice:DescribePhoneNumbers
                - sms-voice:SendTextMessage
              Resource:
                - !Sub arn:aws:sms-voice:${AWS::Region}:${AWS::AccountId}:phone-number/*
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource:
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:configuration-set/*
        - DynamoDBCrudPolicy:
            TableName: !Ref ScheduledMeetingsTable

  addCalendarEventLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${addCalendarEvent}
  ExternalServiceLinkApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub
        - ${ResourceName} From Stack ${AWS::StackName}
        - ResourceName: ExternalServiceLinkApi
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: '''*'''
              Access-Control-Allow-Headers: '''*'''
              Access-Control-Allow-Methods: '''GET, POST, PATCH, PUT, DELETE, OPTIONS'''
          ResponseTemplates:
            application/json: '''Unauthorized'''
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: '''*'''
              Access-Control-Allow-Headers: '''*'''
              Access-Control-Allow-Methods: '''GET, POST, PATCH, PUT, DELETE, OPTIONS'''
          ResponseTemplates:
            application/json: '''Internal Server Error'''
      StageName: Prod
      DefinitionBody:
        openapi: '3.0'
        info: {}
        paths:
          /esl/microsoft:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${initializeMicrosoftESL.Arn}/invocations
              responses: {}
            post:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${storeTokenMicrosoftESL.Arn}/invocations
              responses: {}
          /esl/microsoft/token_status:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getMicrosoftTokenStatus.Arn}/invocations
              responses: {}
          /esl/unlink/all:
            delete:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${unlinkAllESL.Arn}/invocations
              responses: {}
      EndpointConfiguration: REGIONAL
      TracingEnabled: true
      Cors:
        MaxAge: 5
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
        AllowMethods: '''GET, POST, PATCH, PUT, DELETE, OPTIONS'''
      Auth:
        DefaultAuthorizer: JWTAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          JWTAuthorizer:
            FunctionArn: !GetAtt JWTAuthorizerFunction.Arn
  initializeMicrosoftESL:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: initializeMicrosoftESL
      CodeUri: src/initializeMicrosoftESL
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        ExternalServiceLinkApiGETeslmicrosoft:
          Type: Api
          Properties:
            Path: /esl/microsoft
            Method: GET
            RestApiId: !Ref ExternalServiceLinkApi
  initializeMicrosoftESLLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${initializeMicrosoftESL}
  storeTokenMicrosoftESL:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: storeTokenMicrosoftESL
      CodeUri: src/storeTokenMicrosoftESL
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        ExternalServiceLinkApiPOSTeslmicrosoft:
          Type: Api
          Properties:
            Path: /esl/microsoft
            Method: POST
            RestApiId: !Ref ExternalServiceLinkApi
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:CreateSecret
                - secretsmanager:UpdateSecret
                - secretsmanager:DescribeSecret
                - secretsmanager:RotateSecret
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource:
                - !GetAtt rotateMicrosoft.Arn
      Environment:
        Variables:
          ROTATEMICROSOFT_FUNCTION_NAME: !Ref rotateMicrosoft
          ROTATEMICROSOFT_FUNCTION_ARN: !GetAtt rotateMicrosoft.Arn
  storeTokenMicrosoftESLLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${storeTokenMicrosoftESL}
  getMicrosoftTokenStatus:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getMicrosoftTokenStatus
      CodeUri: src/getMicrosoftTokenStatus
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        ExternalServiceLinkApiGETeslmicrosofttokenstatus:
          Type: Api
          Properties:
            Path: /esl/microsoft/token_status
            Method: GET
            RestApiId: !Ref ExternalServiceLinkApi
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:RotateSecret
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
  getMicrosoftTokenStatusLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getMicrosoftTokenStatus}
  PublicExternalServiceApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub
        - ${ResourceName} From Stack ${AWS::StackName}
        - ResourceName: PublicExternalServiceApi
      StageName: Prod
      DefinitionBody:
        openapi: '3.0'
        info: {}
        paths:
          /pesl/microsoft/calendar/{user_id}/{workspace_id}:
            get:
              x-amazon-apigateway-integration:
                httpMethod: POST
                type: aws_proxy
                uri: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getMicrosoftCalendarEvents.Arn}/invocations
              responses: {}
      EndpointConfiguration: REGIONAL
      TracingEnabled: true
      Cors:
        AllowOrigin: '''*'''
        AllowHeaders: '''*'''
        AllowMethods: '''*'''
        MaxAge: 5
  getMicrosoftCalendarEvents:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getMicrosoftCalendarEvents
      CodeUri: src/getMicrosoftCalendarEvents
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:RotateSecret
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectAcl
                - s3:GetObjectLegalHold
                - s3:GetObjectRetention
                - s3:GetObjectTorrent
                - s3:GetObjectVersion
                - s3:GetObjectVersionAcl
                - s3:GetObjectVersionForReplication
                - s3:GetObjectVersionTorrent
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListBucketVersions
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:DeleteObject
                - s3:DeleteObjectVersion
                - s3:PutObject
                - s3:PutObjectLegalHold
                - s3:PutObjectRetention
                - s3:RestoreObject
              Resource:
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}
                - !Sub arn:${AWS::Partition}:s3:::${WorkspacesBucket}/*
      Events:
        PublicExternalServiceApiGETpeslmicrosoftcalendaruseridworkspaceid:
          Type: Api
          Properties:
            Path: /pesl/microsoft/calendar/{user_id}/{workspace_id}
            Method: GET
            RestApiId: !Ref PublicExternalServiceApi
      Environment:
        Variables:
          WORKSPACESBUCKET_BUCKET_NAME: !Ref WorkspacesBucket
          WORKSPACESBUCKET_BUCKET_ARN: !GetAtt WorkspacesBucket.Arn
  getMicrosoftCalendarEventsLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getMicrosoftCalendarEvents}
  rotateMicrosoft:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: rotateMicrosoft
      CodeUri: src/rotateMicrosoft
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:PutSecretValue
                - secretsmanager:DescribeSecret
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
  # policy statements for letting secrets manager invoke rotate functions
  rotateMicrosoftFunctionPolicy:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref rotateMicrosoft
      Principal: secretsmanager.amazonaws.com

  rotateMicrosoftFunctionPolicyStatement:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref rotateMicrosoft
      Principal: secretsmanager.amazonaws.com
      SourceArn: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*

  rotateMicrosoftLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${rotateMicrosoft}
  unlinkAllESL:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: unlinkAllESL
      CodeUri: src/unlinkAllESL
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        ExternalServiceLinkApiDELETEeslunlinkall:
          Type: Api
          Properties:
            Path: /esl/unlink/all
            Method: DELETE
            RestApiId: !Ref ExternalServiceLinkApi
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:UpdateSecret
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
  unlinkAllESLLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${unlinkAllESL}
  hideDemo:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: hideDemo
      CodeUri: src/hideDemo
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        WorkspaceApiPUTworkspacehidedemo:
          Type: Api
          Properties:
            Path: /workspace/hide_demo
            Method: PUT
            RestApiId: !Ref WorkspaceApi
      Environment:
        Variables:
          USERPOOLCLIENT_USER_POOL_CLIENT_ID: !Ref UserPoolClient
  hideDemoLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${hideDemo}
  ScheduledMeetingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
  getScheduledMeetings:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: getScheduledMeetings
      CodeUri: src/getScheduledMeetings
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Environment:
        Variables:
          SCHEDULEDMEETINGSTABLE_TABLE_NAME: !Ref ScheduledMeetingsTable
          SCHEDULEDMEETINGSTABLE_TABLE_ARN: !GetAtt ScheduledMeetingsTable.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ScheduledMeetingsTable
      Events:
        WorkspaceApiGETworkspacescheduledmeetingsid:
          Type: Api
          Properties:
            Path: /workspace/scheduled_meetings/{id}
            Method: GET
            RestApiId: !Ref WorkspaceApi
  getScheduledMeetingsLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${getScheduledMeetings}
  cancelScheduledMeetings:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: cancelScheduledMeetings
      CodeUri: src/cancelScheduledMeetings
      Handler: handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Events:
        WorkspaceApiDELETEworkspacescheduledmeetingsid:
          Type: Api
          Properties:
            Path: /workspace/scheduled_meetings/{id}
            Method: DELETE
            RestApiId: !Ref WorkspaceApi
      Environment:
        Variables:
          SCHEDULEDMEETINGSTABLE_TABLE_NAME: !Ref ScheduledMeetingsTable
          SCHEDULEDMEETINGSTABLE_TABLE_ARN: !GetAtt ScheduledMeetingsTable.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ScheduledMeetingsTable
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*
            - Effect: Allow
              Action:
                - sms-voice:DescribePhoneNumbers
                - sms-voice:SendTextMessage
              Resource:
                - !Sub arn:aws:sms-voice:${AWS::Region}:${AWS::AccountId}:phone-number/*
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource:
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:configuration-set/*
  cancelScheduledMeetingsLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${cancelScheduledMeetings}
  MeetingReminderHourly:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: MeetingReminderHourly
      CodeUri: src/MeetingReminder
      Handler: hourly_handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sms-voice:DescribePhoneNumbers
                - sms-voice:SendTextMessage
              Resource:
                - !Sub arn:aws:sms-voice:${AWS::Region}:${AWS::AccountId}:phone-number/*
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource:
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:configuration-set/*
        - DynamoDBCrudPolicy:
            TableName: !Ref ScheduledMeetingsTable
      Environment:
        Variables:
          SCHEDULEDMEETINGSTABLE_TABLE_NAME: !Ref ScheduledMeetingsTable
          SCHEDULEDMEETINGSTABLE_TABLE_ARN: !GetAtt ScheduledMeetingsTable.Arn
  MeetingReminderHourlyLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${MeetingReminderHourly}
  MeetingReminderHourlySchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      ScheduleExpression: rate(1 hour)
      FlexibleTimeWindow:
        Mode: 'OFF'
      Target:
        Arn: !GetAtt MeetingReminderHourly.Arn
        RoleArn: !GetAtt MeetingReminderHourlyScheduleToMeetingReminderHourlyRole.Arn
  MeetingReminderHourlyScheduleToMeetingReminderHourlyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal:
            Service: scheduler.amazonaws.com
          Action: sts:AssumeRole
      Policies:
        - PolicyName: StartExecutionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt MeetingReminderHourly.Arn
  MeetingReminderDaily:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: MeetingReminderDaily
      CodeUri: src/MeetingReminder
      Handler: daily_handler.handler
      Runtime: python3.9
      MemorySize: 3008
      Timeout: 30
      Tracing: Active
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sms-voice:DescribePhoneNumbers
                - sms-voice:SendTextMessage
              Resource:
                - !Sub arn:aws:sms-voice:${AWS::Region}:${AWS::AccountId}:phone-number/*
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource:
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*
                - !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:configuration-set/*
        - DynamoDBCrudPolicy:
            TableName: !Ref ScheduledMeetingsTable
      Environment:
        Variables:
          SCHEDULEDMEETINGSTABLE_TABLE_NAME: !Ref ScheduledMeetingsTable
          SCHEDULEDMEETINGSTABLE_TABLE_ARN: !GetAtt ScheduledMeetingsTable.Arn
  MeetingReminderDailyLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${MeetingReminderDaily}
  MeetingReminderDailyScheduleDaily:
    Type: AWS::Scheduler::Schedule
    Properties:
      ScheduleExpression: rate(12 hours)
      FlexibleTimeWindow:
        Mode: 'OFF'
      Target:
        Arn: !GetAtt MeetingReminderDaily.Arn
        RoleArn: !GetAtt MeetingReminderDailyScheduleDailyToMeetingReminderRole.Arn
  MeetingReminderDailyScheduleDailyToMeetingReminderRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal:
            Service: scheduler.amazonaws.com
          Action: sts:AssumeRole
      Policies:
        - PolicyName: StartExecutionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt MeetingReminderDaily.Arn
Metadata:
  AWS::Composer::Groups:
    Group:
      Label: Workspace Api
      Members:
        - getWorkspace
        - addWorkspace
        - updateWorkspace
        - deleteWorkspace
        - getAllUserWorkspaces
        - deployWorkspace
        - hideDemo
        - getScheduledMeetings
        - cancelScheduledMeetings
    Group2:
      Label: Pinpoint SMS Service
      Members:
        - WelcomeTemplate
        - AutoSmsChannel
        - AutoSmsPinpointApp
    Group4:
      Label: Users
      Members:
        - addUser
        - deleteUser
        - getUser
        - confirmUser
        - resendCodeUser
        - loginUser
    Group5:
      Label: Users Cognito
      Members:
        - UserPoolClient
        - UserPool
    Group6:
      Label: Scheduling
      Members:
        - getAvailability
        - addCalendarEvent
    Group7:
      Label: External Service Link
      Members:
        - storeTokenMicrosoftESL
        - getMicrosoftTokenStatus
        - initializeMicrosoftESL
        - unlinkAllESL
    Group8:
      Label: Public External Services
      Members:
        - getMicrosoftCalendarEvents
    Group3:
      Label: Meeting Reminders
      Members:
        - MeetingReminderHourlySchedule
        - MeetingReminderDailyScheduleDaily
        - MeetingReminderHourly
        - MeetingReminderDaily
  Outputs:
    WokspaceApi:
      Description: Workspace API
      Value: !Ref WorkspaceApi
    UserApi:
      Description: User API
      Value: !Ref UserApi